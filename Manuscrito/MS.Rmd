---
title: "Relación complejidad-estabilidad en redes tróficas empíricas"
author: "Tomás I. Marina & Nate Colbrunn"
bibliography: Referencias.bib
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE, echo=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Paquetes
library(dplyr)
library(ggplot2)
library(ggpubr)
library(grid)
library(interactions)
library(tidyverse)

```

# Introducción

@May1973

# Materiales y Métodos

## Base de datos

Consideramos dos repositorios públicos de redes tróficas empíricas para construir la base de datos. Dichos repositorios han sido curados y utilizados en diferentes trabajos de investigación [@Marina2018a; @Brose2019; @Perkins2022].
Uno de los repositorios es 'GATEWAy' (GlobAL daTabasE of traits and food Web Architecture), recopilado por el German Center for Integrative Biodiversity Research (iDiv) [@Brose2018], y contiene información sobre 290 redes tróficas de distintas latitudes y ecosistemas. El otro repositorio está almacenado en el paquete de R ‘multiweb’, y contiene 29 redes tróficas complejas de ecosistemas marinos [@Saravia2022a, https://github.com/lsaravia/multiweb]. Descartamos aquellas redes tróficas que tenían más de un componente, es decir que presentaban grupos de especies tróficas desconectados entre sí.
De acuerdo a los metadatos provistos por los repositorios, clasificamos las redes de acuerdo al tipo de ecosistema: dulceacuícola, marino o terrestre.

La base de datos está compuesta por 314 redes tróficas empíricas, que varían de 10 a 521 en el número de especies y de 16 a 15821 en el número de interacciones, y que pertenecen a ecosistemas dulceacuícolas (n = 81), marinos (n = 160) y terrestres (n = 73) (Figura 1).

```{r fig1, echo=FALSE, fig.align='center', fig.width=6.5, fig.height=5, fig.cap="Ubicación geográfica de las redes tróficas empíricas analizadas y tipo de ecosistema al que pertenecen (dulceacuícola = 81, marino = 160, terrestre = 73)."}

# Datos
load("../Resultados/all_res.rda")
load("../Data/metadata.rda")

# Descartar redes con 2 componentes
fw_2_comp <- prop_comp %>% 
  filter(., Components == 2) %>% 
  dplyr::select(Network, Components)
fw_2_disc <- pull(fw_2_comp, Network)
all_meta_ok <- all_meta %>% 
  filter(!Network %in% c(fw_2_disc))

# Mapa
cols <- c("Dulceacuícola"="#D55E00", "Marino"="#0072B2", "Terrestre"="#009E73")
world <- map_data("world")
ggplot() +
  geom_map(data = world, map = world, aes(long, lat, map_id = region),
    color = "black", fill = "lightgray", size = 0.1) +
  geom_point(data = all_meta_ok,
    aes(Longitude, Latitude, color = factor(Ecosystem)), alpha = 0.7) +
  scale_color_manual(values=cols) +
  labs(x = "Longitud", y = "Latitud", color = "Ecosistema") +
  theme(panel.background = element_blank(),
        legend.position = "top",
        legend.key=element_rect(fill='white'))

```

## Análisis de complejidad y estabilidad

Existen diferentes propiedades que caracterizan la complejidad de una red trófica. Éstas son: el númmero de especies ($S$), el número de interacciones ($L$), la densidad de interacciones ($L/S$) y la conectividad ($L/S^2$) [@Martinez1992]. En este trabajo consideramos la conectividad como propiedad resumen de la complejidad, porque tiene en cuenta ambos componentes de una red, las especies y sus interacciones, y revela la proporción de interacciones reales con respecto a las posibles la cantidad de interacciones [@Dunne2002a].

Para analizar la estabilidad de las redes tróficas tuvimos en cuenta dos propiedades: 1) modularidad y 2) índice 'Quasi-Sign Stability'. La modularidad es una medida indirecta de la estabilidad. Caracteriza la fuerza, en cantidad de interacciones, con la que ciertas especies se conectan entre sí formando grupos (módulos) con respecto a especies de otros grupos. Redes más modulares son más estables, ya que los módulos previenen la dispersión de perturbaciones a lo largo de la red [@Stouffer2011; @Grilli2016]. Se calcula como la diferencia entre las interacciones reales y las esperadas dentro de los módulos dividida por el número total de interacciones. Usamos el algoritmo estocástico llamado recocido simulado o 'simulated annealing' [@Guimera2005], que asume que las especies de un mismo módulo tienen más interacciones de las que se esperarían en una red aleatoria. Los módulos se obtienen dividiendo todas las especies de la red para maximizar la modularidad. De esta forma, la ecuación para calcular la modularidad se define como:

$$
Mod = \sum_{s} (\frac{I_s} {L} - (\frac{d_s}{2L})^2)
$$
donde $s$ es el número total de módulos, $I_s$ es el número de interacciones entre especies del mismo módulo, $d_s$ es la suma de las interacciones totales de las especies del módulo $s$ y $L$ es el número total de interacciones de la red.

El índice 'Quasi-Sign Stability' (QSS) es una medida directa de la estabilidad que revela la amplificación de pequeñas perturbaciones cerca del punto de equilibrio [@Allesina2008]. Se estima como la proporción de matrices comunitarias, o matriz jacobiana, localmente estables. Para ello se simulan matrices aleatorias de la red a analizar manteniendo el signo de la interacción, en este caso positivo para el depredador y negativo para la presa, y se calcula el promedio de los máximos autovalores negativos de la matriz. Cuanto más negativo o más cercano a cero es el autovalor, mayor es la probabilidad de que la red trófica sea estable. Realizamos 1000 simulaciones para cada red analizada.

Realizamos los análisis con el software libre R [@RCoreTeam2022] utilizando los siguientes paquetes: igraph [@Csardi2006] y multiweb [@Saravia2022a]. La base de datos y el código desarrollado para el análisis de los datos se encuentra en https://github.com/TomasMarina/Estabilidad-Complejidad.

# Resultados

Descripción de resultados.

```{r fig2, echo=FALSE, fig.align='center', fig.width = 6.5, fig.height = 4, fig.cap="Relación entre (A) modularidad e (B) índice QSS con la complejidad (conectividad) en redes tróficas empíricas. Cada punto representa una red trófica. Regresión lineal para modularidad ($y = 0.40 - 1.2x, R^2 = 0.50, p-value < 2.16e-16$) e índice QSS ($y = 3.86 - 4.2x, R^2 < 0.01, p-value = 0.09$). En (B) se muestran regresiones de cuantiles 25 y 75."}

# Datos
load("../Resultados/all_res.rda")
load("../Data/metadata.rda")
## Descartar redes c/2 componentes de metadata
all_meta_ok <- all_meta %>% 
  filter(!Network %in% c(fw_2_disc)) %>% 
  dplyr::select(Ecosystem)
all_data <- cbind(all_res, all_meta_ok) %>% 
  dplyr::select(Network, Ecosystem, everything())

# Regresión lineal
## Modularidad
reg_mod_gral <- all_data %>% 
  ggplot(aes(x = Connectance, y = Modularity)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Complejidad", y = "Modularidad") +
  theme_classic() +
  theme(axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10))

## QSS
reg_qss_gral <- all_data %>% 
  ggplot(aes(x = Connectance, y = QSS_MEing)) +
  geom_point() +
  scale_y_reverse() +
  geom_smooth(method = "lm") +
  labs(x = "Complejidad", y = "Índice QSS") +
  theme_classic() +
  theme(axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10))
reg_qss_q <- reg_qss_gral + 
  geom_quantile(quantiles = 0.75) + geom_quantile(quantiles = 0.25)

# Figura
fig_2 <- ggarrange(reg_mod_gral + rremove("x.title"), reg_qss_q + rremove("x.title"),
                     ncol = 2, labels = c("A","B"))
annotate_figure(fig_2, bottom = textGrob("Complejidad", gp = gpar(cex = 1.1)))

```


```{r fig3, echo=FALSE, fig.align='center', fig.width=6.5, fig.height=6, fig.cap="Relación modularidad-complejidad (panel superior) y distribución de los datos de modularidad y complejidad (panel inferior) en redes tróficas empíricas de ecosistemas dulceacuícolas, marinos y terrestres. Regresión lineal para redes dulceacuícolas ($y = 0.40 - 1.27x, R^2 = 0.44, p-value < 0.001$), marinas ($y = 0.38 - 1.13x, R^2 = 0.52, p-value < 0.001$) y terrestres ($y = 0.38 - 0.88x, R^2 = 0.24, p-value < 0.001$)."}

cols <- c("Dulceacuícola"="#D55E00", "Marino"="#0072B2", "Terrestre"="#009E73")

## Modularidad
reg_mod_eco <- all_data %>% 
  ggplot(aes(x = Connectance, y = Modularity)) +
  geom_point(aes(color = factor(Ecosystem))) +
  scale_color_manual(values=cols) +
  facet_wrap(~ Ecosystem) +
  labs(x = "Complejidad", y = "Estabilidad (Mod)") +
  geom_smooth(method = "lm", color = "grey25") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"),
        legend.position = "none")

bx_mod_eco <- all_data %>% 
  ggplot(aes(x = Connectance, y = Modularity)) +
  geom_boxplot(aes(color = factor(Ecosystem), fill = factor(Ecosystem)), alpha=0.1) +
  geom_jitter(size=0.3, aes(color = factor(Ecosystem), fill = factor(Ecosystem))) +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  facet_wrap(~ Ecosystem) +
  labs(x = "Complejidad", y = "Estabilidad (Mod)") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"),
        legend.position = "none")

# Figura
fig_mod <- ggarrange(reg_mod_eco + rremove("x.title") + rremove("y.title"), bx_mod_eco + rremove("y.title") +rremove("x.title"),
          nrow = 2)
annotate_figure(fig_mod, left = textGrob("Modularidad", rot = 90, vjust = 1, gp = gpar(cex = 1.1)),
                bottom = textGrob("Complejidad", gp = gpar(cex = 1.1)))

```


```{r fig4, echo=FALSE, fig.align='center', fig.width=6.5, fig.height=6, fig.cap="Relación índice QSS-complejidad (panel superior) y distribución de los datos del índice QSS y complejidad (panel inferior) en redes tróficas empíricas de ecosistemas dulceacuícolas, marinos y terrestres. Regresión lineal para redes dulceacuícolas ($y = - 0.13 - 18x, R^2 = 0.32, p-value < 0.001$), marinas ($y = - 3.5 - 6.8x, R^2 = 0.06, p-value < 0.002$) y terrestres ($y = - 5.7 - 3x, R^2 < 0.01, p-value < 0.799$)."}

## QSS
reg_qss_eco <- all_data %>% 
  ggplot(aes(x = Connectance, y = QSS_MEing)) +
  geom_point(aes(color = factor(Ecosystem))) +
  scale_color_manual(values=cols) +
  scale_y_reverse() +
  facet_wrap(~ Ecosystem) +
  labs(x = "Complejidad", y = "Estabilidad (QSS)") +
  geom_smooth(method = "lm", color = "grey25") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"),
        legend.position = "none")

bx_qss_eco <- all_data %>% 
  ggplot(aes(x = Connectance, y = QSS_MEing)) +
  geom_boxplot(aes(color = factor(Ecosystem), fill = factor(Ecosystem)), alpha=0.1) +
  geom_jitter(size=0.3, aes(color = factor(Ecosystem), fill = factor(Ecosystem))) +
  scale_fill_manual(values=cols) +
  scale_color_manual(values=cols) +
  scale_y_reverse() +
  facet_wrap(~ Ecosystem) +
  labs(x = "Complejidad", y = "Estabilidad (QSS)") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"),
        legend.position = "none")

# Figura
fig_qss <- ggarrange(reg_qss_eco + rremove("x.title") + rremove("y.title"), bx_qss_eco + rremove("y.title") + rremove("x.title"),
                     nrow = 2)
annotate_figure(fig_qss, left = textGrob("Índice QSS", rot = 90, vjust = 1, gp = gpar(cex = 1.1)),
                bottom = textGrob("Complejidad", gp = gpar(cex = 1.1)))

```


# Discusión

Descripción de discusión.

# Literatura Citada